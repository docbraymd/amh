<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metabolic Health Calculator | Archangel Michael Health</title>

  <!-- html2pdf for one-click PDF download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* ARCHANGEL MICHAEL HEALTH - MERGED STYLES */
    :root {
      /* Brand Colors */
      --amh-primary-dark: #2c3e50;
      --amh-primary-light: #34495e;
      --amh-accent-teal: #16a085;
      --amh-accent-indigo: #667eea;
      --amh-accent-green: #27ae60;
      
      /* Surfaces */
      --amh-bg-page: linear-gradient(135deg, var(--amh-primary-dark) 0%, var(--amh-primary-light) 100%);
      --amh-bg-card: #ffffff;
      --amh-bg-soft: #f8f9fa;
      
      /* Typography */
      --amh-font: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --amh-text: #333333;
      --amh-text-soft: #555555;
      
      /* Layout */
      --amh-radius: 10px;
      --amh-shadow: 0 10px 25px rgba(0, 0, 0, 0.20);
    }

    body {
      font-family: var(--amh-font);
      margin: 0;
      padding: 0;
      background: var(--amh-bg-page);
      color: var(--amh-text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-container {
      max-width: 950px;
      margin: 40px auto;
      background: var(--amh-bg-card);
      box-shadow: var(--amh-shadow);
      border-radius: var(--amh-radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 600px) {
      .main-container { margin: 0; border-radius: 0; }
    }

    /* --- HEADER STYLES (Branded) --- */
    .amh-header {
      background: var(--amh-bg-page);
      color: #ffffff;
      border-bottom: 5px solid var(--amh-accent-teal);
      padding: 40px 30px;
      text-align: center;
    }
    .amh-header-inner {
      max-width: 800px;
      margin: 0 auto;
    }
    .amh-logo-wrap {
      margin-bottom: 15px;
    }
    .amh-logo {
      height: 80px;
      width: auto;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); 
    }
    .doctor-tag {
      background: var(--amh-accent-teal);
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-block;
      margin-bottom: 10px;
    }
    .amh-title {
      margin: 0.2em 0;
      font-size: 2.2rem;
      font-weight: 800;
      color: #ffffff;
      line-height: 1.2;
    }
    .amh-tagline {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 300;
      color: rgba(255, 255, 255, 0.9);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .byline {
      margin-top: 10px;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.7);
      font-style: italic;
    }
    .amh-actions {
      margin-top: 25px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .amh-btn {
      appearance: none;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .amh-btn-primary {
      background: var(--amh-accent-teal);
      color: #fff;
    }
    .amh-btn-primary:hover { background: #138a72; }
    .amh-btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .amh-btn-secondary:hover { background: rgba(255, 255, 255, 0.25); }

    /* Content Area */
    .content-body { padding: 40px; }
    @media (max-width: 600px) { .content-body { padding: 20px; } }

    /* --- CALCULATOR SPECIFIC STYLES --- */
    
    /* Unit Toggle */
    .unit-toggle-container {
      display: flex;
      justify-content: center;
      margin-bottom: 25px;
    }
    .unit-toggle {
      display: flex;
      background: #eee;
      border-radius: 20px;
      padding: 4px;
      cursor: pointer;
    }
    .unit-option {
      padding: 6px 20px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.9rem;
      color: #666;
      transition: all 0.2s;
    }
    .unit-option.active {
      background: var(--amh-primary-dark);
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Form Styles */
    .calc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    @media (max-width: 600px) { .calc-grid { grid-template-columns: 1fr; } }

    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-weight: 700; color: var(--amh-primary-dark); margin-bottom: 5px; font-size: 0.9rem; }
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }
    .input-group select { cursor: pointer; }
    .optional-tag { font-size: 0.8em; color: #888; font-weight: 400; margin-left: 5px; }

    .btn-calculate {
      width: 100%;
      background: var(--amh-accent-teal);
      color: white;
      border: none;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 800;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 10px;
    }
    .btn-calculate:hover { background: #138a72; }

    /* Results Section */
    #results-area {
      display: none; /* Hidden by default */
      margin-top: 40px;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* BMI Display */
    .bmi-header-card {
      background: var(--amh-primary-dark);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .bmi-value-large {
      font-size: 3rem;
      font-weight: 900;
      line-height: 1;
      margin: 10px 0;
    }
    .bmi-label-large {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
    }

    /* Metrics Grid */
    .result-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .metric-card {
      background: var(--amh-bg-soft);
      border: 1px solid #eee;
      border-left: 5px solid var(--amh-accent-teal);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .metric-card.highlight {
      background: #e8f6f3;
      border-color: var(--amh-accent-teal);
    }
    .metric-title { font-size: 0.85rem; text-transform: uppercase; color: #666; font-weight: 700; letter-spacing: 0.5px; }
    .metric-value { font-size: 2.2rem; font-weight: 800; color: var(--amh-primary-dark); margin: 10px 0; }
    .metric-sub { font-size: 0.9rem; color: #666; }

    /* Visual Bar Chart */
    .expenditure-visual {
      margin: 30px 0;
      background: #f0f0f0;
      border-radius: 10px;
      height: 40px;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    .bar-bmr { background: var(--amh-accent-teal); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
    .bar-neat { background: var(--amh-accent-indigo); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
    .bar-tef { background: var(--amh-primary-light); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }

    .legend { display: flex; gap: 20px; justify-content: center; font-size: 0.85rem; color: #555; margin-bottom: 20px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; }

    /* TABLES Styling */
    .tables-wrapper {
      display: flex;
      flex-direction: column;
      gap: 30px;
      margin-top: 30px;
    }
    .status-table-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .table-header {
      background: var(--amh-primary-dark);
      color: white;
      padding: 10px 15px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    .status-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .status-table th, .status-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .status-table th {
      background: #f8f9fa;
      color: var(--amh-primary-dark);
      font-weight: 700;
      font-size: 0.85rem;
    }
    .row-green { background-color: rgba(39, 174, 96, 0.1); border-left: 5px solid #27ae60; }
    .row-yellow { background-color: rgba(243, 156, 18, 0.1); border-left: 5px solid #f39c12; }
    .row-red { background-color: rgba(231, 76, 60, 0.1); border-left: 5px solid #e74c3c; }
    .row-blue { background-color: rgba(52, 152, 219, 0.1); border-left: 5px solid #3498db; }
    
    .row-active {
      box-shadow: inset 0 0 0 2px var(--amh-primary-dark);
      font-weight: 700;
      position: relative;
    }
    .row-active::after {
      content: "YOUR STATUS";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--amh-primary-dark);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
    }

    /* TIMELINE BOX */
    .timeline-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .timeline-box {
      background: #eef2ff;
      border: 1px solid #dbeafe;
      border-left: 5px solid var(--amh-accent-indigo);
      padding: 20px;
      border-radius: 8px;
    }
    .timeline-header {
      font-weight: 700;
      color: var(--amh-accent-indigo);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    .timeline-val-big {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--amh-primary-dark);
      margin: 5px 0;
    }
    .timeline-sub {
      font-size: 0.85rem;
      color: #666;
    }

    /* Educational Sections */
    .edu-section {
      border-top: 1px solid #eee;
      padding-top: 30px;
      margin-top: 30px;
    }
    .edu-section h3 { color: var(--amh-primary-dark); margin-top: 0; }
    
    .alert-box {
      background: #fff5f5;
      border-left: 5px solid #dc3545;
      color: #8a1f1f;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      font-size: 0.95rem;
    }

    /* References Section */
    .ref-section {
      margin-top: 40px;
      border-top: 2px solid #eee;
      padding-top: 20px;
    }
    .ref-list {
      padding-left: 20px;
      color: #666;
      font-size: 0.85rem;
    }
    .ref-list li {
      margin-bottom: 8px;
    }

    .hand-guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .hand-card {
      background: var(--amh-bg-soft);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #eee;
    }
    .hand-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    .hand-title { font-weight: 700; color: var(--amh-primary-dark); display: block; margin-bottom: 5px;}
    .macro-detail {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed #ddd;
        font-size: 0.8rem;
        color: #555;
        line-height: 1.4;
    }

    .ai-tip {
      background: #eef2ff;
      border: 1px solid #dbeafe;
      padding: 20px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
      align-items: start;
    }
    .ai-icon { font-size: 1.5rem; color: var(--amh-accent-indigo); }
    
    /* Footer Standard */
    .amh-footer {
      background: var(--amh-bg-soft);
      border-top: 1px solid #e0e0e0;
      padding: 40px 30px;
      font-size: 0.85rem;
      color: var(--amh-text-soft);
      text-align: center;
      margin-top: auto;
    }
    .amh-disclaimer {
      max-width: 800px;
      margin: 0 auto 20px auto;
      line-height: 1.5;
    }
    .amh-footer-meta {
      display: flex;
      justify-content: center;
      gap: 10px;
      color: #999;
    }
    .amh-dot { color: #ccc; }

    /* Helpers */
    .hidden { display: none; }
    
    /* Print Hiding */
    @media print {
      .no-print { display: none !important; }
      .amh-page { box-shadow: none; margin: 0; max-width: 100%; border-radius: 0; }
    }
  </style>
</head>
<body>

  <!-- Main Container with ID for PDF Generation -->
  <div class="amh-page main-container" id="pdf-root" role="document">
    
    <!-- HEADER -->
    <header class="amh-header">
      <div class="amh-header-inner amh-header-centered">
        <div class="amh-logo-wrap">
          <img class="amh-logo" src="https://docbraymd.github.io/amh/AMHLogo.png" alt="Archangel Michael Health logo" />
        </div>

        <div class="amh-practice doctor-tag">Archangel Michael Health</div>

        <h1 class="amh-title" id="page-title">Metabolic Health Calculator</h1>
        <h2 class="amh-tagline">Science-Based Energy Expenditure Estimation</h2>
        <div class="byline">by Christopher L. Bray MD PhD</div>

        <div class="action-bar amh-actions no-print" aria-label="Actions">
          <button class="amh-btn amh-btn-secondary" type="button" onclick="window.print()">
            Print / Save as PDF
          </button>
          <button class="amh-btn amh-btn-primary" id="downloadPdfBtn" type="button">
            Download PDF
          </button>
        </div>
      </div>
    </header>

    <div class="amh-content content-body">
      <p style="text-align: center; margin-bottom: 20px;">
        Use this tool to estimate your <strong>Basal Metabolic Rate (BMR)</strong> and see exactly where you stand on clinical health charts normed for your background.
      </p>

      <!-- Unit Toggle -->
      <div class="unit-toggle-container no-print">
        <div class="unit-toggle">
          <div class="unit-option active" id="btn-us" onclick="setUnits('us')">US (Lbs, Ft/In)</div>
          <div class="unit-option" id="btn-metric" onclick="setUnits('metric')">Metric (Kg, Cm)</div>
        </div>
      </div>

      <!-- CALCULATOR FORM -->
      <form id="metabolicForm" class="no-print" onsubmit="calculateMetabolism(event)">
        <div class="calc-grid">
          
          <!-- Column 1 -->
          <div>
            <div class="input-group">
              <label for="gender">Biologic Sex</label>
              <select id="gender" required>
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>
            
            <div class="input-group">
              <label for="age">Age (years)</label>
              <input type="number" id="age" placeholder="e.g., 45" min="18" max="120" required>
            </div>

            <!-- US Height -->
            <div class="input-group us-input">
              <label>Height</label>
              <div style="display: flex; gap: 10px;">
                <input type="number" id="feet" placeholder="Ft" min="1" max="8" style="flex: 1">
                <input type="number" id="inches" placeholder="In" min="0" max="11" style="flex: 1">
              </div>
            </div>
            <!-- Metric Height -->
            <div class="input-group metric-input hidden">
              <label for="cm">Height (cm)</label>
              <input type="number" id="cm" placeholder="e.g. 175" min="50" max="250">
            </div>

            <div class="input-group">
              <label for="race">Race / Ethnicity <span class="optional-tag">(Crucial for clinical cutoffs)</span></label>
              <select id="race">
                <option value="standard">White / Caucasian</option>
                <option value="black">Black / African American</option>
                <option value="middle_eastern">Middle Eastern / Arab</option>
                <option value="hispanic">Hispanic / Latino</option>
                <option value="asian">Asian (East, South, SE)</option>
                <option value="native">Native American / Alaska Native</option>
                <option value="pacific">Native Hawaiian / Pacific Islander</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <!-- Column 2 -->
          <div>
            <!-- US Weight -->
            <div class="input-group us-input">
              <label for="weight-lbs">Weight (lbs)</label>
              <input type="number" id="weight-lbs" placeholder="e.g., 185" min="50" max="600">
            </div>
            <!-- Metric Weight -->
            <div class="input-group metric-input hidden">
              <label for="weight-kg">Weight (kg)</label>
              <input type="number" id="weight-kg" placeholder="e.g., 85" min="20" max="300">
            </div>

            <div class="input-group">
              <label for="activity">Activity Level</label>
              <select id="activity" required>
                <option value="1.2">Sedentary (Desk job, little exercise)</option>
                <option value="1.375">Lightly Active (Light exercise 1-3 days/week)</option>
                <option value="1.55">Moderately Active (Moderate exercise 3-5 days/week)</option>
                <option value="1.725">Very Active (Hard exercise 6-7 days/week)</option>
                <option value="1.9">Extra Active (Physical job + training)</option>
              </select>
            </div>

            <!-- US Waist -->
            <div class="input-group us-input">
              <label for="waist-in">Waist Circumference (in) <span class="optional-tag">Optional</span></label>
              <input type="number" id="waist-in" placeholder="e.g., 36" min="15" max="100" step="0.5">
            </div>
            <!-- Metric Waist -->
            <div class="input-group metric-input hidden">
              <label for="waist-cm">Waist Circumference (cm) <span class="optional-tag">Optional</span></label>
              <input type="number" id="waist-cm" placeholder="e.g., 90" min="40" max="250" step="0.5">
            </div>

            <div class="input-group">
              <label for="bodyfat">Body Fat % <span class="optional-tag">Optional</span></label>
              <input type="number" id="bodyfat" placeholder="e.g., 25" min="2" max="70" step="0.1">
            </div>
          </div>
        </div>

        <button type="submit" class="btn-calculate">Calculate My Targets</button>
      </form>

      <!-- RESULTS SECTION (Hidden initially) -->
      <div id="results-area">
        
        <!-- BMI LARGE DISPLAY -->
        <div class="bmi-header-card">
          <div class="bmi-label-large">Your Calculated BMI</div>
          <div class="bmi-value-large" id="bmi-display-val">--</div>
          <div id="bmi-category-text" style="font-size:1.1rem; opacity:0.9;"></div>
        </div>

        <!-- VISUAL BREAKDOWN -->
        <div class="edu-section" style="margin-top: 0; padding-top: 0; border: none;">
          <h3 style="text-align: center;">Your Daily Energy Breakdown</h3>
          <p style="text-align: center; font-size: 0.9rem; color: #666; max-width: 600px; margin: 0 auto 20px auto;">
            This bar shows how you burn calories. <strong>BMR</strong> is the energy used just to stay alive. <strong>TEF</strong> (Thermic Effect of Food) is the energy used to digest and metabolize your meals. <strong>Activity</strong> is intentional exercise plus daily movement.
          </p>

          <div class="expenditure-visual" id="barChart">
            <!-- Bars injected via JS -->
          </div>
          <div class="legend">
            <div class="legend-item"><div class="dot" style="background: var(--amh-accent-teal)"></div> BMR (Basal Rate)</div>
            <div class="legend-item"><div class="dot" style="background: var(--amh-primary-light)"></div> TEF (Digestion)</div>
            <div class="legend-item"><div class="dot" style="background: var(--amh-accent-indigo)"></div> Activity (Movement)</div>
          </div>
        </div>

        <!-- CALORIE CARDS -->
        <div class="result-cards">
          <div class="metric-card">
            <div class="metric-title">Maintenance</div>
            <div class="metric-value" id="val-maint">--</div>
            <div class="metric-sub">Calories to maintain current weight</div>
          </div>
          <div class="metric-card highlight">
            <div class="metric-title">Mild Deficit (-200)</div>
            <div class="metric-value" id="val-200">--</div>
            <div class="metric-sub">Slow, sustainable loss (Rec.)</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Moderate Deficit (-500)</div>
            <div class="metric-value" id="val-500">--</div>
            <div class="metric-sub">~1 lb/week loss</div>
          </div>
        </div>

        <div class="alert-box">
          <strong>Dr. Bray's Clinical Warning:</strong> Do not restrict calories below your BMR (approx. <span id="text-bmr">--</span>) for extended periods. Chronic severe restriction causes "metabolic adaptation," leading to plateaus and rapid regain.
        </div>

        <!-- GOAL TIMELINES -->
        <div class="edu-section" id="goals-section">
          <h3>Estimated Time to Reach Normal Ranges</h3>
          <p style="font-size:0.9rem; color:#666;">
            Estimates assume a consistent 200 calorie/day deficit (approx 0.4 lbs loss/week). This conservative pace preserves metabolic health.
          </p>
          
          <div class="timeline-container" id="timeline-container">
            <!-- JS will inject boxes here -->
          </div>
        </div>

        <!-- TABLES SECTION -->
        <div class="tables-wrapper" id="tables-wrapper">
          
          <!-- 1. BMI TABLE -->
          <div class="status-table-container">
            <div class="table-header">Body Mass Index (BMI) Categories</div>
            <table class="status-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Range (kg/m¬≤)</th>
                  <th>Risk Level</th>
                </tr>
              </thead>
              <tbody id="bmi-table-body">
                <!-- JS Injected -->
              </tbody>
            </table>
          </div>

          <!-- 2. WAIST TABLE -->
          <div class="status-table-container">
            <div class="table-header">Waist Circumference Risk Categories</div>
            <table class="status-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Range (Current Units)</th>
                  <th>Metabolic Risk</th>
                </tr>
              </thead>
              <tbody id="waist-table-body">
                <!-- JS Injected -->
              </tbody>
            </table>
          </div>

          <!-- 3. WAIST-TO-HEIGHT TABLE -->
          <div class="status-table-container">
            <div class="table-header">Waist-to-Height Ratio (WHtR) Categories</div>
            <table class="status-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Ratio</th>
                  <th>Risk Level</th>
                </tr>
              </thead>
              <tbody id="whtr-table-body">
                <!-- JS Injected -->
              </tbody>
            </table>
          </div>

          <!-- 4. BODY FAT TABLE -->
          <div class="status-table-container">
            <div class="table-header">Body Fat Percentage Categories</div>
            <table class="status-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Range (%)</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="bf-table-body">
                <!-- JS Injected -->
              </tbody>
            </table>
          </div>

        </div>

        <!-- REFERENCES -->
        <div class="ref-section">
          <h3>Clinical References & Norms</h3>
          <ul class="ref-list">
            <li><strong>BMI Categorization:</strong> Centers for Disease Control and Prevention (CDC), WHO, and AACE Consensus Statement 2025. Asian-specific cutoffs derived from WHO Expert Consultation (2004) and AACE/ACE Guidelines.</li>
            <li><strong>Waist Circumference:</strong> International Diabetes Federation (IDF) Consensus Worldwide Definition of the Metabolic Syndrome (2006). Ethnicity-specific values for South Asians, Chinese, and Japanese populations; European cutoffs used for Middle Eastern and Mediterranean populations per IDF/AHA recommendations.</li>
            <li><strong>Waist-to-Height Ratio (WHtR):</strong> Ashwell M, et al. "Waist-to-height ratio is a better screening tool than waist circumference and BMI for adult cardiometabolic risk factors." <em>Obesity Reviews</em> (2012). NICE Guidelines (2022).</li>
            <li><strong>Body Fat Percentage:</strong> American Council on Exercise (ACE) General Population Norms. Gallagher D, et al. "Healthy percentage body fat ranges: an approach for developing guidelines based on body mass index." <em>Am J Clin Nutr</em> (2000).</li>
          </ul>
        </div>

        <!-- EDUCATIONAL CONTENT -->
        <div class="edu-section">
          <h3>How to Track Calories Without Obsessing</h3>
          <div class="ai-tip">
            <div class="ai-icon">üì∏</div>
            <div>
              <strong>Use AI for Calorie Estimation:</strong><br>
              Calorie counting is tedious and often inaccurate. I recommend using modern AI tools (like ChatGPT or specialized apps). Simply <strong>take a picture</strong> of your meal and ask: 
              <em>"Estimate the calories and macronutrients in this meal."</em><br>
              This provides a quick, low-stress way to stay aware of your intake without weighing every gram of food.
            </div>
          </div>

          <h4 style="margin-top: 30px;">Instinctual Portion Guide</h4>
          <p>If you prefer not to count calories, use your hand as a personalized measuring tool. This adjusts automatically to your body size.</p>
          <div class="hand-guide-grid">
            <div class="hand-card">
              <span class="hand-icon">‚úã</span>
              <span class="hand-title">Protein</span>
              1 Palm<br><small>(Thickness & diameter)</small>
              <div class="macro-detail">
                ~4 kcal/g<br>
                Serving: ~3-4 oz (85-115g)<br>
                ~120-150 kcal (lean)
              </div>
            </div>
            <div class="hand-card">
              <span class="hand-icon">‚úä</span>
              <span class="hand-title">Vegetables</span>
              1 Fist<br><small>(As much as you can eat)</small>
              <div class="macro-detail">
                ~0.25 kcal/g<br>
                Serving: ~1 cup (75-150g)<br>
                ~25-50 kcal
              </div>
            </div>
            <div class="hand-card">
              <span class="hand-icon">ü§≤</span>
              <span class="hand-title">Carbs</span>
              1 Cupped Hand<br><small>(Rice, potatoes, fruit)</small>
              <div class="macro-detail">
                ~4 kcal/g<br>
                Serving: ~¬Ω cup (100g)<br>
                ~100-150 kcal
              </div>
            </div>
            <div class="hand-card">
              <span class="hand-icon">üëç</span>
              <span class="hand-title">Fats</span>
              1 Thumb<br><small>(Oils, nuts, butter)</small>
              <div class="macro-detail">
                ~9 kcal/g<br>
                Serving: ~1 tbsp (14g)<br>
                ~100-120 kcal
              </div>
            </div>
          </div>
        </div>

      </div> 
      <!-- End Content Body -->

      <!-- STANDARD FOOTER -->
      <footer class="amh-footer">
        <div class="amh-disclaimer medical-disclaimer">
          <p><strong>Medical disclaimer:</strong> The information on this page is provided for general educational purposes only and is not medical advice. It is not intended to diagnose, treat, cure, or prevent any disease, and it does not establish a physician‚Äìpatient relationship.</p>
          <p>Do not apply this information to your specific situation without the oversight of a qualified clinician who can consider your full health history, medications, goals, preferences, and limitations. If you have urgent or severe symptoms, seek emergency care.</p>
          <p style="margin: 0;"><strong>Copyright:</strong> ¬© Dr. Bray at Archangel Michael Health <span id="amh-year">2025</span></p>
        </div>

        <div class="amh-footer-meta">
          <span><strong>Archangel Michael Health</strong> | Internal &amp; Integrative Medicine</span>
          <span class="amh-dot">‚Ä¢</span>
          <span><strong>Last updated:</strong> <span id="amh-last-updated">‚Äî</span></span>
        </div>
      </footer>

    </div> 
    <!-- End Page Container -->

  <script>
    // --- UTILITY: Dynamic Dates ---
    (function () {
      var yearEl = document.getElementById("amh-year");
      if (yearEl) { try { yearEl.textContent = String(new Date().getFullYear()); } catch (e) {} }
      var updatedEl = document.getElementById("amh-last-updated");
      if (updatedEl) {
        var d = new Date();
        var yyyy = d.getFullYear();
        var mm = String(d.getMonth() + 1).padStart(2, "0");
        var dd = String(d.getDate()).padStart(2, "0");
        updatedEl.textContent = yyyy + "-" + mm + "-" + dd;
      }
    })();

    // --- PDF GENERATION LOGIC ---
    var btn = document.getElementById("downloadPdfBtn");
    if (btn) {
      function safeFilename(title) {
        return (title || "patient-guide").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
      }

      btn.addEventListener("click", function () {
        if (typeof html2pdf === "undefined") {
          alert("PDF generator is still loading. Please try again in a moment, or use Print / Save as PDF.");
          return;
        }

        btn.disabled = true;
        btn.textContent = "Preparing PDF...";

        var title = (document.getElementById("page-title") && document.getElementById("page-title").textContent) || "Metabolic Calculator";
        var filename = safeFilename(title) + ".pdf";

        // Clone content for PDF and remove UI elements
        var source = document.getElementById("pdf-root").cloneNode(true);
        source.querySelectorAll(".no-print").forEach(function (el) { el.remove(); });

        var wrapper = document.createElement("div");
        wrapper.style.background = "#ffffff";
        wrapper.appendChild(source);

        var opt = {
          margin: [0.3, 0.3, 0.4, 0.3], // inches
          filename: filename,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, letterRendering: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
          pagebreak: { mode: ["css", "legacy"] }
        };

        html2pdf()
          .set(opt)
          .from(wrapper)
          .save()
          .catch(function (err) {
            console.error(err);
            alert("Could not generate the PDF in this browser. Please use Print / Save as PDF.");
          })
          .finally(function () {
            btn.disabled = false;
            btn.textContent = "Download PDF";
          });
      });
    }

    // --- CALCULATOR LOGIC ---
    let currentUnit = 'us'; // 'us' or 'metric'

    function setUnits(unit) {
      currentUnit = unit;
      if (unit === 'us') {
        document.getElementById('btn-us').classList.add('active');
        document.getElementById('btn-metric').classList.remove('active');
        document.querySelectorAll('.us-input').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.metric-input').forEach(el => el.classList.add('hidden'));
      } else {
        document.getElementById('btn-metric').classList.add('active');
        document.getElementById('btn-us').classList.remove('active');
        document.querySelectorAll('.metric-input').forEach(el => el.classList.remove('hidden'));
        document.querySelectorAll('.us-input').forEach(el => el.classList.add('hidden'));
      }
    }

    function calculateMetabolism(e) {
      e.preventDefault();

      // 1. INPUTS
      const gender = document.getElementById('gender').value;
      const age = parseInt(document.getElementById('age').value);
      const activityMult = parseFloat(document.getElementById('activity').value);
      const race = document.getElementById('race').value;
      
      let weightLbs, heightInTotal, waistIn;

      if (currentUnit === 'us') {
        weightLbs = parseFloat(document.getElementById('weight-lbs').value);
        const feet = parseInt(document.getElementById('feet').value) || 0;
        const inches = parseInt(document.getElementById('inches').value) || 0;
        heightInTotal = (feet * 12) + inches;
        waistIn = document.getElementById('waist-in').value ? parseFloat(document.getElementById('waist-in').value) : null;
      } else {
        const weightKg = parseFloat(document.getElementById('weight-kg').value);
        weightLbs = weightKg * 2.20462; 
        const heightCm = parseFloat(document.getElementById('cm').value);
        heightInTotal = heightCm / 2.54;
        const waistCm = document.getElementById('waist-cm').value ? parseFloat(document.getElementById('waist-cm').value) : null;
        waistIn = waistCm ? waistCm / 2.54 : null;
      }

      const bodyFat = document.getElementById('bodyfat').value ? parseFloat(document.getElementById('bodyfat').value) : null;

      // 2. ENERGY CALCULATIONS
      const weightKg = weightLbs / 2.20462;
      const heightCm = heightInTotal * 2.54;

      let bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age);
      if (gender === 'male') { bmr += 5; } else { bmr -= 161; }

      const tdee = bmr * activityMult;
      const tef = tdee * 0.10;
      const activityCals = tdee - bmr - tef;

      document.getElementById('val-maint').textContent = Math.round(tdee) + " kcal";
      document.getElementById('val-200').textContent = Math.round(tdee - 200) + " kcal";
      document.getElementById('val-500').textContent = Math.round(tdee - 500) + " kcal";
      document.getElementById('text-bmr').textContent = Math.round(bmr) + " kcal";

      const total = tdee;
      const pctBmr = (bmr / total) * 100;
      const pctTef = (tef / total) * 100;
      const pctAct = (activityCals / total) * 100;
      document.getElementById('barChart').innerHTML = `
        <div class="bar-bmr" style="width: ${pctBmr}%">BMR ${Math.round(bmr)} kcal</div>
        <div class="bar-tef" style="width: ${pctTef}%">TEF</div>
        <div class="bar-neat" style="width: ${pctAct}%">Move ${Math.round(activityCals)} kcal</div>
      `;

      // 3. BMI CALC & DISPLAY
      let bmi = (703 * weightLbs) / (heightInTotal * heightInTotal);
      bmi = parseFloat(bmi.toFixed(1));
      
      document.getElementById('bmi-display-val').textContent = bmi;

      // 4. TIMELINES & GOALS
      // Constants
      let timelineHtml = "";
      
      // Determine Race-Based Cutoffs
      // Asian/Hispanic cutoffs: Normal <23, Overweight <25, Obese I <30 (Standard Asian Action points)
      // Standard/Middle Eastern cutoffs: Normal <25, Overweight <30
      
      let isLowerCutoffGroup = (race === 'asian' || race === 'hispanic');
      let bmiTarget = isLowerCutoffGroup ? 22.9 : 24.9;
      
      // -- BMI Timeline --
      if (bmi > bmiTarget) {
        let targetWeight = (bmiTarget * heightInTotal * heightInTotal) / 703;
        let diffLbs = weightLbs - targetWeight;
        let months = (diffLbs / 0.4) / 4.3; // 200cal deficit
        
        let displayTargetWeight = Math.round(targetWeight);
        let weightUnit = "lbs";
        if (currentUnit === 'metric') {
            displayTargetWeight = Math.round(targetWeight / 2.20462);
            weightUnit = "kg";
        }
        
        timelineHtml += `
          <div class="timeline-box">
            <div class="timeline-header">
              <span>üìâ</span> BMI Goal
            </div>
            <div class="timeline-val-big">~${Math.ceil(months)} Months</div>
            <div class="timeline-sub">To reach Normal BMI (${bmiTarget})<br>Target Weight: ${displayTargetWeight} ${weightUnit}</div>
          </div>
        `;
        document.getElementById('bmi-category-text').textContent = "Above Normal Range";
      } else {
        document.getElementById('bmi-category-text').textContent = "Normal Range";
        timelineHtml += `
          <div class="timeline-box" style="border-left-color: var(--amh-accent-green); background: #f0fdf4;">
            <div class="timeline-header" style="color: var(--amh-accent-green);">
              <span>‚úÖ</span> BMI Goal
            </div>
            <div class="timeline-val-big">Achieved</div>
            <div class="timeline-sub">You are in the normal range</div>
          </div>
        `;
      }

      // -- Waist Timeline --
      // Asian/Hispanic M < 35.5 (90cm), F < 31.5 (80cm)
      // Standard/Middle Eastern M < 37 (94cm), F < 31.5 (80cm) - IDF European cutoffs
      
      if (waistIn) {
        let wTarget = 0;
        if (gender === 'male') { wTarget = isLowerCutoffGroup ? 35.5 : 37.0; } 
        else { wTarget = 31.5; }
        
        if (waistIn > wTarget) {
          let diffIn = waistIn - wTarget;
          // Heuristic: 5 lbs per inch
          let lbsNeeded = diffIn * 5; 
          let months = (lbsNeeded / 0.4) / 4.3;
          
          let displayTargetWaist = wTarget;
          let unitLabel = "in";
          if (currentUnit === 'metric') {
             displayTargetWaist = (wTarget * 2.54).toFixed(1);
             unitLabel = "cm";
          }
          
          timelineHtml += `
            <div class="timeline-box">
              <div class="timeline-header">
                <span>üìè</span> Waist Goal
              </div>
              <div class="timeline-val-big">~${Math.ceil(months)} Months</div>
              <div class="timeline-sub">To reach Normal Waist (< ${displayTargetWaist} ${unitLabel})</div>
            </div>
          `;
        } else {
           timelineHtml += `
            <div class="timeline-box" style="border-left-color: var(--amh-accent-green); background: #f0fdf4;">
              <div class="timeline-header" style="color: var(--amh-accent-green);">
                <span>‚úÖ</span> Waist Goal
              </div>
              <div class="timeline-val-big">Achieved</div>
              <div class="timeline-sub">Your waist is in normal range</div>
            </div>
          `;
        }
      }

      // -- Waist-to-Height Ratio (WHtR) Timeline --
      // Goal: < 0.5
      if (waistIn) {
        let whtr = waistIn / heightInTotal;
        whtr = parseFloat(whtr.toFixed(2));
        
        if (whtr >= 0.5) {
          let targetWaist = heightInTotal * 0.5;
          let diffIn = waistIn - targetWaist;
          let lbsNeeded = diffIn * 5; // 5 lbs per inch heuristic
          let months = (lbsNeeded / 0.4) / 4.3;
          
          timelineHtml += `
            <div class="timeline-box">
              <div class="timeline-header">
                <span>üìê</span> WHtR Goal
              </div>
              <div class="timeline-val-big">~${Math.ceil(months)} Months</div>
              <div class="timeline-sub">To reach ratio < 0.5<br>(Current: ${whtr})</div>
            </div>
          `;
        } else {
          timelineHtml += `
            <div class="timeline-box" style="border-left-color: var(--amh-accent-green); background: #f0fdf4;">
              <div class="timeline-header" style="color: var(--amh-accent-green);">
                <span>‚úÖ</span> WHtR Goal
              </div>
              <div class="timeline-val-big">Achieved</div>
              <div class="timeline-sub">Ratio is healthy (${whtr})</div>
            </div>
          `;
        }
      }

      // -- Body Fat Timeline --
      if (bodyFat) {
        let bfTarget = (gender === 'male') ? 24.9 : 31.9;
        if (bodyFat > bfTarget) {
          let diffBf = bodyFat - bfTarget;
          let lbsNeeded = diffBf * 2;
          let months = (lbsNeeded / 0.4) / 4.3;
          
          timelineHtml += `
            <div class="timeline-box">
              <div class="timeline-header">
                <span>üí™</span> Body Fat Goal
              </div>
              <div class="timeline-val-big">~${Math.ceil(months)} Months</div>
              <div class="timeline-sub">To reach Normal Body Fat (< ${Math.ceil(bfTarget)}%)</div>
            </div>
          `;
        } else {
          timelineHtml += `
            <div class="timeline-box" style="border-left-color: var(--amh-accent-green); background: #f0fdf4;">
              <div class="timeline-header" style="color: var(--amh-accent-green);">
                <span>‚úÖ</span> Body Fat Goal
              </div>
              <div class="timeline-val-big">Achieved</div>
              <div class="timeline-sub">Your body fat is in normal range</div>
            </div>
          `;
        }
      }

      document.getElementById('timeline-container').innerHTML = timelineHtml;


      // 5. TABLE GENERATION LOGIC
      
      // --- BMI TABLE ---
      let bmiRanges = [];
      if (isLowerCutoffGroup) {
        bmiRanges = [
          { name: "Underweight", max: 18.4, class: "row-blue", risk: "Nutritional Risk" },
          { name: "Normal Range", max: 22.9, class: "row-green", risk: "Low Risk" },
          { name: "Overweight", max: 24.9, class: "row-yellow", risk: "Increased Risk" },
          { name: "Obesity Class I", max: 29.9, class: "row-red", risk: "High Risk" },
          { name: "Obesity Class II", max: 34.9, class: "row-red", risk: "Very High Risk" },
          { name: "Obesity Class III", max: 999, class: "row-red", risk: "Extreme Risk" }
        ];
      } else {
        bmiRanges = [
          { name: "Underweight", max: 18.4, class: "row-blue", risk: "Nutritional Risk" },
          { name: "Normal Range", max: 24.9, class: "row-green", risk: "Low Risk" },
          { name: "Overweight", max: 29.9, class: "row-yellow", risk: "Increased Risk" },
          { name: "Obesity Class I", max: 34.9, class: "row-red", risk: "High Risk" },
          { name: "Obesity Class II", max: 39.9, class: "row-red", risk: "Very High Risk" },
          { name: "Obesity Class III", max: 999, class: "row-red", risk: "Extreme Risk" }
        ];
      }

      let bmiHtml = "";
      let minVal = 0;
      bmiRanges.forEach(r => {
        let isActive = (bmi >= minVal && bmi <= r.max);
        let rangeLabel = r.max > 100 ? `‚â• ${minVal}` : `${minVal} ‚Äì ${r.max}`;
        bmiHtml += `
          <tr class="${r.class} ${isActive ? 'row-active' : ''}">
            <td>${r.name}</td>
            <td>${rangeLabel}</td>
            <td>${r.risk}</td>
          </tr>
        `;
        minVal = (r.max + 0.1).toFixed(1); 
      });
      document.getElementById('bmi-table-body').innerHTML = bmiHtml;


      // --- WAIST TABLE ---
      let waistHtml = "";
      if (waistIn) {
        let isMetric = currentUnit === 'metric';
        let val = isMetric ? (waistIn * 2.54) : waistIn;
        val = parseFloat(val.toFixed(1));

        let cut1, cut2, cut3;
        
        if (gender === 'male') {
          // Asian/Hispanic vs Standard/Middle Eastern
          if (isLowerCutoffGroup) { cut1=35.5; cut2=39.5; cut3=43.5; } 
          else { cut1=37.0; cut2=40.2; cut3=45.0; }
        } else {
          // Female (Same for both usually, 80cm)
          if (isLowerCutoffGroup) { cut1=31.5; cut2=35.5; cut3=39.5; }
          else { cut1=31.5; cut2=35.0; cut3=40.0; }
        }

        let dCut1 = isMetric ? (cut1 * 2.54).toFixed(1) : cut1;
        let dCut2 = isMetric ? (cut2 * 2.54).toFixed(1) : cut2;
        let dCut3 = isMetric ? (cut3 * 2.54).toFixed(1) : cut3;
        let unitLabel = isMetric ? 'cm' : 'in';

        let waistRanges = [
          { name: "Normal / Low Risk", max: cut1, display: `< ${dCut1} ${unitLabel}`, class: "row-green", risk: "Healthy" },
          { name: "Increased Risk", max: cut2, display: `${dCut1} ‚Äì ${dCut2} ${unitLabel}`, class: "row-yellow", risk: "Caution" },
          { name: "High Risk", max: cut3, display: `${dCut2} ‚Äì ${dCut3} ${unitLabel}`, class: "row-red", risk: "Warning" },
          { name: "Very High Risk", max: 999, display: `> ${dCut3} ${unitLabel}`, class: "row-red", risk: "Danger" }
        ];

        let wMin = 0;
        waistRanges.forEach(r => {
          let isActive = (waistIn > wMin && waistIn <= r.max);
          if (r.name.includes("Normal")) isActive = waistIn <= r.max;
          if (r.name.includes("Very High")) isActive = waistIn > cut3; 

          waistHtml += `
            <tr class="${r.class} ${isActive ? 'row-active' : ''}">
              <td>${r.name}</td>
              <td>${r.display}</td>
              <td>${r.risk}</td>
            </tr>
          `;
          wMin = r.max;
        });
        document.getElementById('waist-table-body').innerHTML = waistHtml;
      } else {
        document.getElementById('waist-table-body').innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888;">Enter waist size to see risk category</td></tr>`;
      }

      // --- WHtR TABLE ---
      let whtrHtml = "";
      if (waistIn) {
        let ratio = waistIn / heightInTotal;
        let whtrRanges = [
          { name: "Healthy", max: 0.49, class: "row-green", risk: "Low Cardiometabolic Risk" },
          { name: "Increased Risk", max: 0.59, class: "row-yellow", risk: "Consider Action" },
          { name: "High Risk", max: 999, class: "row-red", risk: "Take Action" }
        ];
        
        let minR = 0;
        whtrRanges.forEach(r => {
          let isActive = (ratio >= minR && ratio <= r.max);
          let label = r.max > 10 ? `‚â• 0.60` : `${minR.toFixed(1)} ‚Äì ${r.max}`;
          if (r.name.includes("Healthy")) label = `< 0.50`;
          
          whtrHtml += `
            <tr class="${r.class} ${isActive ? 'row-active' : ''}">
              <td>${r.name}</td>
              <td>${label}</td>
              <td>${r.risk}</td>
            </tr>
          `;
          minR = r.max + 0.01;
        });
        document.getElementById('whtr-table-body').innerHTML = whtrHtml;
      } else {
        document.getElementById('whtr-table-body').innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888;">Enter waist size to see WHtR</td></tr>`;
      }


      // --- BODY FAT TABLE ---
      let bfHtml = "";
      if (bodyFat) {
        let bfRanges = [];
        if (gender === 'male') {
          bfRanges = [
            { name: "Essential Fat", max: 5.9, class: "row-blue", desc: "Minimal Physiological" },
            { name: "Athletic", max: 13.9, class: "row-green", desc: "High Performance" },
            { name: "Fitness", max: 17.9, class: "row-green", desc: "Healthy / Active" },
            { name: "Average / Acceptable", max: 24.9, class: "row-green", desc: "Normal" },
            { name: "Overfat", max: 29.9, class: "row-yellow", risk: "Excess Adiposity" },
            { name: "Obese", max: 999, class: "row-red", risk: "High Health Risk" }
          ];
        } else {
          bfRanges = [
            { name: "Essential Fat", max: 13.9, class: "row-blue", desc: "Minimal Physiological" },
            { name: "Athletic", max: 20.9, class: "row-green", desc: "High Performance" },
            { name: "Fitness", max: 24.9, class: "row-green", desc: "Healthy / Active" },
            { name: "Average / Acceptable", max: 31.9, class: "row-green", desc: "Normal" },
            { name: "Overfat", max: 36.9, class: "row-yellow", risk: "Excess Adiposity" },
            { name: "Obese", max: 999, class: "row-red", risk: "High Health Risk" }
          ];
        }

        let bfMin = 0;
        bfRanges.forEach(r => {
          let isActive = (bodyFat >= bfMin && bodyFat <= r.max);
          let label = r.max > 100 ? `‚â• ${Math.floor(bfMin)}` : `${Math.floor(bfMin)} ‚Äì ${Math.floor(r.max)}`;
          if (r.name.includes("Essential")) label = `< ${Math.floor(r.max)}`;

          bfHtml += `
            <tr class="${r.class} ${isActive ? 'row-active' : ''}">
              <td>${r.name}</td>
              <td>${label}%</td>
              <td>${r.desc || r.risk}</td>
            </tr>
          `;
          bfMin = r.max + 0.1;
        });
        document.getElementById('bf-table-body').innerHTML = bfHtml;
      } else {
        document.getElementById('bf-table-body').innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888;">Enter body fat % to see category</td></tr>`;
      }


      // SHOW RESULTS
      document.getElementById('results-area').style.display = 'block';
      document.getElementById('results-area').scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
